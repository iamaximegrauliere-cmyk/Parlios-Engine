name: Readme Autogen

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - README.md
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Generate README
        shell: bash
        run: |
          python - <<'PY'
import pathlib

# RÃ©pertoires Ã  ignorer dans l'arborescence
IGNORE_DIRS = {
    ".git","__pycache__","node_modules",".venv",
    ".idea",".vscode","dist","build",".github"
}

ROOT = pathlib.Path(".").resolve()

def tree(root, prefix=""):
    lines = []
    entries = sorted(
        [p for p in root.iterdir() if p.name not in IGNORE_DIRS],
        key=lambda p: (p.is_file(), p.name.lower())
    )
    for i, e in enumerate(entries):
        conn = "â””â”€â”€ " if i == len(entries)-1 else "â”œâ”€â”€ "
        lines.append(prefix + conn + e.name + ("/" if e.is_dir() else ""))
        if e.is_dir():
            ext = "    " if i == len(entries)-1 else "â”‚   "
            lines.extend(tree(e, prefix + ext))
    return lines

tree_block = "```\n" + "\n".join(tree(ROOT)) + "\n```"

readme = f"""# Parlios-Engine

Orchestrateur dâ€™IA personnalisÃ©e (v4). README auto-gÃ©nÃ©rÃ© par CI.

## ðŸ—‚ Structure
{tree_block}

## ðŸš€ DÃ©marrage rapide
Voir sections Installation / Lancement dans le code source.
"""

( ROOT / "README.md" ).write_text(readme, encoding="utf-8")
print("README.md gÃ©nÃ©rÃ©.")
PY

      - name: Commit README if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if [[ -n "$(git status --porcelain README.md)" ]]; then
            git add README.md
            git commit -m "docs: auto-update README"
            git push
          else
            echo "Pas de changement."
          fi
